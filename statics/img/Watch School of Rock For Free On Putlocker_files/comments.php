"use strict";var SComment=SComment||function SComment(id,options,instance){this.createThread.apply(this,arguments)};SComment.frontendReady=true;SComment.backendReady=false;SComment.instanceCount=1;var SCommentConstructor=SComment;SCommentConstructor.onReady=function(callback){var state=document.readyState;if(state==='interactive'||state==='complete'){callback()}else{document.addEventListener('DOMContentLoaded',function(){callback()},false)}};SCommentConstructor.script=(function(){var loaderScript=document.getElementById('sc-loader');var scripts=document.getElementsByTagName('script');var currentScript=document.currentScript||loaderScript;return currentScript||scripts[scripts.length-1]})();SCommentConstructor.getCanonical=function(){if(typeof(document.querySelector)==='function'){var canonical=document.querySelector('link[rel="canonical"]');if(canonical!==null&&canonical.href){var canonicalHref=canonical.href;canonicalHref=canonicalHref.split('?ep=')[0];canonicalHref=canonicalHref.split('/ep-')[0];return canonicalHref}}var head=document.head||document.getElementsByTagName('head')[0];var links=head.getElementsByTagName('link');for(var i=0,il=links.length;i<il;i++){if(links[i].rel==='canonical'&&links[i].href){return links[i].href}}var pageURL=window.location.href.split('#')[0];pageURL=pageURL.split('?ep=')[0];pageURL=pageURL.split('/ep-')[0];return pageURL};SCommentConstructor.getURL=function(canonical){if(canonical===false){var pageURL=window.location.href.split('#')[0];pageURL=pageURL.split('?ep=')[0];pageURL=pageURL.split('/ep-')[0];return pageURL}return SCommentConstructor.getCanonical()};SCommentConstructor.getTitle=function(){return document.title};SCommentConstructor.cfgQueries=function(value,name,queries){name=name||[];queries=queries||[];if(typeof(value)!=='object'){var matrix='['+name.join('][')+']';var value=encodeURIComponent(value);queries.push('cfg'+matrix+'='+value);return}for(var key in value){SCommentConstructor.cfgQueries(value[key],name.concat(key),queries)}return queries};SCommentConstructor.getClientTime=function(){var datetime=new Date();var hours=datetime.getHours();var minutes=datetime.getMinutes();var time=hours+':'+minutes;return time};SCommentConstructor.prototype.getBackendQueries=function(options,instance,auto){options=options||{};var data={};var queries=[];data.instance=instance;if(options.url&&typeof(options.url)==='string'){data.url=options.url}else{if(auto!==false){data.url=SCommentConstructor.getURL(options.canonical)}}if(options.title&&typeof(options.title)==='string'){data.title=options.title}else{if(auto!==false){data.title=SCommentConstructor.getTitle()}}if(options.website&&typeof(options.website)==='string'){data.website=options.website}if(options.thread&&typeof(options.thread)==='string'){data.thread=options.thread}for(var name in data){if(data.hasOwnProperty(name)===true){queries.push(name+'='+encodeURIComponent(data[name]))}}if(options.settings&&options.settings.constructor===Object){var cfgQueries=SCommentConstructor.cfgQueries(options.settings);queries=queries.concat(cfgQueries)}return queries};SCommentConstructor.jsonp=[function(json){alert(json.message);}];SCommentConstructor.prototype.jsonp=function(method,path,data,callback,async){var source=this.constructor.toString();var constructor=source.match(/function(\w+)/)[1];this.constructor.jsonp.push(callback);data.push('jsonp='+(this.constructor.jsonp.length-1));data.push('jsonp_object='+constructor||'SComment');var script=document.createElement('script');script.src=path+'?'+data.join('&');script.async=async;document.body.appendChild(script)};SCommentConstructor.prototype.ajax=function(method,path,data,callback,async){var sc=this;var args=arguments;var onSuccess=function(){var json=JSON.parse(this.responseText);callback.apply(this,[ json ])};var onError=function(){sc.jsonp.apply(sc,args);sc.ajax=sc.jsonp};if('withCredentials' in new XMLHttpRequest()){var xhr=new XMLHttpRequest();xhr.onreadystatechange=function(){if(this.readyState!==4){return}if(this.status===200){return onSuccess.apply(this)}if(this.status===0){return onError()}};xhr.open(method,path,async);xhr.setRequestHeader('Content-type','application/x-www-form-urlencoded');xhr.withCredentials=true;xhr.send(data.join('&'));return}if(typeof(XDomainRequest)!=='undefined'){var xdr=new XDomainRequest();xdr.open(method,path);xdr.onload=onSuccess;xdr.onerror=onError;setTimeout(xdr.send,0);return}onError()};SCommentConstructor.rootPath=(function(){var scriptSrc=SCommentConstructor.script.getAttribute('src');var root=scriptSrc.replace(/\/[^\/]*\/?$/,'');return root})();SCommentConstructor.backendPath=(function(){return SCommentConstructor.rootPath+'/backend'})();SComment.instantiator=function(id,options,instance){var sc=this;var specific=this.rx.integer.test(instance);var instance=SComment.instanceCount;var requestPath=SComment.backendPath+'/comments-ajax.php';var backendQueries=this.getBackendQueries(options,instance);const read_ep=document.querySelector("#comments").dataset.ren;const write_ep=document.querySelector("#comments").dataset.wen;var queries=backendQueries.concat(['time='+SComment.getClientTime(),'read='+read_ep,'write='+write_ep]);this.instanceNumber=instance;this.options=options;this.queries=backendQueries;this.ajax('POST',requestPath,queries,function(json){if(json.message!==undefined){sc.displayError(json);return}sc.locale=json.locale;sc.setup=json.setup;sc.ui=sc.strings.templatify(json.ui);sc.instance=json.instance;sc.instance.collapseLimit=0;sc.statistics=json.statistics;console.log(sc.strings.sprintf('SComment: backend %d ms, %s',[json.statistics['execution-time'],json.statistics['script-memory']]));SComment.backendReady=true;sc.init(id)},true)};SComment.prototype.createThread=function(id,options,instance){var sc=this;var args=arguments;if(SComment.backendReady===true||SComment.instanceCount===1){SComment.onReady(function(){SComment.instantiator.apply(sc,args)})}else{setTimeout(function(){sc.createThread.apply(sc,args)},10)}};SCommentConstructor.prototype.addProperties=function(element,properties){if(!element||!properties||properties.constructor!==Object){return element}for(var property in properties){if(properties.hasOwnProperty(property)===false){continue}var value=properties[property];if(!!value&&value.constructor===Object){this.addProperties(element[property],value);continue}element[property]=value}return element};SCommentConstructor.prototype.createElement=function(name,attr){var element=document.createElement(name||'span');if(attr&&attr.constructor===Object){element=this.addProperties(element,attr)}return element};SCommentConstructor.prototype.classes=new(function(){if(document.documentElement.classList){this.contains=function(element,name){return element.classList.contains(name)};this.add=function(element,name){element.classList.add(name)};this.remove=function(element,name){element.classList.remove(name)};return}this.contains=function(element,name){if(element&&element.className){var rx=new RegExp('(^|\\s)'+name+'(\\s|$)');return rx.test(element.className)}return false};this.add=function(element,name){if(element&&!this.contains(element,name)){element.className+=(element.className?' ':'')+name}};this.remove=function(element,name){if(element&&element.className){var rx=new RegExp('(^|\\s)'+name+'(\\s|$)','g');element.className=element.className.replace(rx,'$2')}}})();SCommentConstructor.prototype.getMainElement=function(id){id=id||this.prefix();var element=document.getElementById(id);if(element===null){var script=this.constructor.script;element=this.createElement('div',{id:id});if(document.body.contains(script)===true){script.parentNode.insertBefore(element,script)}else{document.body.appendChild(element)}}this.classes.add(element,'sc');if(this.constructor.backendReady===true){this.classes.add(element,'sc-'+this.setup['device-type']);if(this.setup['image-format']==='svg'){this.classes.add(element,'sc-vector')}else{this.classes.add(element,'sc-raster')}if(this.setup['user-is-logged-in']===true){this.classes.add(element,'sc-logged-in')}else{this.classes.add(element,'sc-logged-out')}}return element};SCommentConstructor.prototype.displayError=function(json,id){var mainElement=this.getMainElement(id);var messageHTML='<b>SComment</b>: '+json.message;mainElement.innerHTML=messageHTML};SCommentConstructor.prototype.prefix=function(id){var prefix='sc';if(this.instanceNumber>1){prefix+='-'+this.instanceNumber}if(id){return prefix+'-'+id}return prefix};SCommentConstructor.prototype.rx=new(function(){this.urls='((http|https|ftp):\/\/[a-z0-9-@:;%_\+.~#?&\/=]+)',this.links=new RegExp(this.urls+'( {0,1})','ig'),this.thread=/^(c[0-9r]+)r[0-9\-pop]+$/,this.imageTags=new RegExp('\\[img\\](<a.*?>'+this.urls+'</a>)\\[/img\\]','ig'),this.EOLTrim=/^[\r\n]+|[\r\n]+$/g,this.paragraphs=/(?:\r\n|\r|\n){2}/g,this.email=/\S+@\S+/,this.integer=/^\d+$/})();SCommentConstructor.prototype.EOLTrim=function(string){return string.replace(this.rx.EOLTrim,'')};SCommentConstructor.prototype.strings={specifiers:/%([cdfs])/g,curlyBraces:/(\{.+?\})/g,curlyNames:/\{(.+?)\}/,sprintf:function(string,args){var string=string||'';var args=args||[];var count=0;return string.replace(this.specifiers,function(match,type){if(args[count]===undefined){return match}switch(type){case 'c':{return args[count++][0]}case 'd':{return parseInt(args[count++])}case 'f':{return parseFloat(args[count++])}case 's':{return args[count++]}}})},templatifier:function(text){var template=text.split(this.curlyBraces);var indexes={};for(var i=0,il=template.length;i<il;i++){var curly=template[i].match(this.curlyNames);if(curly!==null&&curly[1]!==undefined){var name=curly[1];if(indexes[name]!==undefined){indexes[name].push(i)}else{indexes[name]=[ i ]}template[i]=''}}return{template:template,indexes:indexes}},templatify:function(ui){var template={};for(var name in ui){if(ui.hasOwnProperty(name)===true){template[name]=this.templatifier(ui[name])}}return template},parseTemplate:function(template,data){var textClone=template.template.slice();for(var name in data){var indexes=template.indexes[name];if(indexes===undefined){continue}for(var i=0,il=indexes.length;i<il;i++){textClone[(indexes[i])]=data[name]}}var text=textClone.join('');return text}};SCommentConstructor.prototype.permalinkParent=function(permalink){var parent=permalink.split('r');var length=parent.length-1;if(this.setup['stream-mode']===true){length=Math.min(this.setup['stream-depth'],length)}if(length>0){parent=parent.slice(0,length);return parent.join('r')}return null};SCommentConstructor.prototype.permalinkComment=function(permalink,comments){for(var i=0,il=comments.length;i<il;i++){var comment=comments[i];if(comment.permalink===permalink){return comment}if(comment.replies!==undefined){var reply=this.permalinkComment(permalink,comment.replies);if(reply!==null){return reply}}}return null};SComment.prototype.addRatings=function(comment,template,action,commentKey){var opposite=(action==='like')?'dislike':'like';var prefix=this.prefix();if(comment[action+'d']!==undefined){var className='sc-'+action+'d';var title=this.locale[action+'d-comment'];var text=(action==='like')?'<i class="far fa-thumbs-up mr-1"></i>':'<i class="far fa-thumbs-down mr-1"></i>'}else{var className='sc-'+action;var title=this.locale[action+'-comment'];var text=(action==='like')?'<i class="far fa-thumbs-up mr-1"></i>':'<i class="far fa-thumbs-down mr-1"></i>'}if(this.setup['allows-'+opposite+'s']===true){className+=' sc-'+opposite+'s-enabled'}template[action+'-link']=this.strings.parseTemplate(this.ui[action+'-link'],{sc:prefix,permalink:commentKey,class:className,title:title,text:text});if(comment[action+'s']!==undefined){template[action+'s']=comment[action+'s'];if(comment[action+'s']!==1){var count=comment[action+'s'];}else{var count=comment[action+'s'];}}template[action+'-count']=this.strings.parseTemplate(this.ui[action+'-count'],{sc:prefix,permalink:commentKey,text:count||''})};SCommentConstructor.prototype.optionalMethod=function(name,args,object){var method=object?this[object][name]:this[name];var context=object?this[object]:this;if(method&&typeof(method)==='function'){return method.apply(context,args)}};SCommentConstructor.prototype.rx.md={blockCode:/```([\s\S]+?)```/g,inlineCode:/(^|[^a-z0-9`])`((?!`)[\s\S]+?)`([^a-z0-9`]|$)/ig,blockMarker:/CODE_BLOCK\[([0-9]+)\]/g,inlineMarker:/CODE_INLINE\[([0-9]+)\]/g,search:[/\*\*([^ *])([\s\S]+?)([^ *])\*\*/g,/\*([^ *])([\s\S]+?)([^ *])\*/g,/(^|\W)_((?!_)[\s\S]+?)_(\W|$)/g,/__([^ _])([\s\S]+?)([^ _])__/g,/~~([^ ~])([\s\S]+?)([^ ~])~~/g],replace:['<strong>$1$2$3</strong>','<em>$1$2$3</em>','$1<u>$2</u>$3','<u>$1$2$3</u>','<s>$1$2$3</s>']};SCommentConstructor.prototype.parseMarkdown=function(string){var sc=this;var block={marks:[],count:0};var inline={marks:[],count:0};var inlineReplacer=function(m,first,code,third){var markCount=inline.count++;var marker='CODE_INLINE['+markCount+']';inline.marks[markCount]=sc.EOLTrim(code);return first+marker+third};string=string.replace(this.rx.md.blockCode,function(m,code){var markCount=block.count++;block.marks[markCount]=sc.EOLTrim(code);return 'CODE_BLOCK['+markCount+']'});var ps=string.split(this.rx.paragraphs);for(var i=0,il=ps.length;i<il;i++){ps[i]=ps[i].replace(this.rx.md.inlineCode,inlineReplacer);for(var r=0,rl=this.rx.md.search.length;r<rl;r++){ps[i]=ps[i].replace(this.rx.md.search[r],this.rx.md.replace[r])}ps[i]=ps[i].replace(this.rx.md.inlineMarker,function(marker,number){return '<code class="sc-inline">'+inline.marks[number]+'</code>'})}string=ps.join(this.setup['server-eol']+this.setup['server-eol']);string=string.replace(this.rx.md.blockMarker,function(marker,number){return '<code>'+block.marks[number]+'</code>'});return string};SCommentConstructor.prototype.closeEmbeddedImage=function(image){var sc=this;image.onload=function(){this.title=sc.locale['external-image-tip'];sc.classes.remove(this.parentNode,'sc-loading');sc.classes.remove(this.parentNode,'sc-embedded-image-open');this.onload=null};image.src=image.dataset.placeholder};SCommentConstructor.prototype.openEmbeddedImage=function(image){var sc=this;if(image.src===image.dataset.url){this.closeEmbeddedImage(image);return}image.title=this.locale['loading'];this.classes.add(image.parentNode,'sc-loading');image.onload=function(){this.title=sc.locale['click-to-close'];sc.classes.remove(this.parentNode,'sc-loading');sc.classes.add(this.parentNode,'sc-embedded-image-open');this.onload=null};image.onerror=function(){sc.closeEmbeddedImage(this)};image.src=image.dataset.url};SCommentConstructor.prototype.embedImage=function(m,link,url){var sc=this;var urlExtension=url.split('#')[0];urlExtension=urlExtension.split('?')[0];urlExtension=urlExtension.split('.');urlExtension=urlExtension.pop();if(this.setup['image-extensions'].indexOf(urlExtension)>-1){var embeddedImage=this.createElement('span',{className:'sc-embedded-image-wrapper'});embeddedImage.appendChild(this.createElement('img',{className:'sc-embedded-image',src:this.setup['image-placeholder'],title:this.locale['external-image-tip'],alt:'External Image',dataset:{placeholder:sc.setup['image-placeholder'],url:url}}));return embeddedImage.outerHTML}return link};SCommentConstructor.prototype.rx.html={linksReplace:'<a href="$1" rel="noopener noreferrer" target="_blank">$1</a>',lines:/(?:\r\n|\r|\n)/g,code:{open:/<code>/i,replace:/(<code>)([\s\S]*?)(<\/code>)/ig,marker:/CODE_TAG\[([0-9]+)\]/g},pre:{open:/<pre>/i,replace:/(<pre>)([\s\S]*?)(<\/pre>)/ig,marker:/PRE_TAG\[([0-9]+)\]/g},trimTags:{open:/<(blockquote|ul|ol)>/,replace:/(<(blockquote|ul|ol)>)([\s\S]*?)(<\/\2>)/ig}};SCommentConstructor.prototype.parseComment=function(comment,parent,collapse,popular){parent=parent||null;var sc=this;var commentKey=comment.permalink;var permalink=this.prefix(commentKey);var nameClass='sc-name-plain';var commentDate=comment.date;var codeTagCount=0;var codeTags=[];var preTagCount=0;var preTags=[];var classes='';var replies='';var prefix=this.prefix();var template={sc:prefix,permalink:commentKey};var permatext=commentKey.slice(1).split('r').pop();if(popular===true){parent=this.permalinkParent(commentKey);if(parent!==null){parent=this.permalinkComment(parent,this.instance.comments.primary)}permatext=permatext.replace('-pop','')}else{if(parent!==null){classes+=' sc-reply'}if(collapse===true&&this.instance['total-count']>0){if(this.instance.collapseLimit>=this.setup['collapse-limit']){if(parent===null){classes+=' sc-hidden'}}else{if(parent===null){this.instance.collapseLimit++}}}}template.avatar=this.strings.parseTemplate(this.ui['user-avatar'],{src:comment.avatar,href:permalink,text:permatext});if(comment.notice===undefined){var name=comment.name||this.setup['default-name'];var website=comment.website;var isTwitter=(name.charAt(0)==='@');if(isTwitter===true){name=name.slice(1);nameClass='sc-name-twitter';var nameLength=name.length;if(nameLength>1&&nameLength<=30){if(website===undefined){website='http://twitter.com/'+name}}}if(website!==undefined){if(isTwitter===false){nameClass='sc-name-website'}var nameElement=this.strings.parseTemplate(this.ui['name-link'],{sc:prefix,href:website,permalink:commentKey,name:name})}else{var nameElement=this.strings.parseTemplate(this.ui['name-span'],{sc:prefix,permalink:commentKey,name:name})}if((comment.url&&comment.title)!==undefined){template['thread-link']=this.strings.parseTemplate(this.ui['thread-link'],{url:comment.url,title:comment.title})}if(parent!==null&&this.ui['parent-link']!==undefined){var parentThread='sc-'+parent.permalink;var parentName=parent.name||this.setup['default-name'];template['parent-link']=this.strings.parseTemplate(this.ui['parent-link'],{sc:prefix,href:comment.url||this.instance['file-path'],parent:parentThread,permalink:commentKey,name:parentName})}if(comment['user-owned']!==undefined){classes+=' sc-user-owned';var replyTitle=this.locale['commenter-tip'];var replyClass='sc-no-email'}else{if(comment.subscribed===true){var replyTitle=name+' '+this.locale['subscribed-tip'];var replyClass='sc-has-email'}else{var replyTitle=name+' '+this.locale['unsubscribed-tip'];var replyClass='sc-no-email'}}if((comment['editable']&&this.ui['edit-link'])!==undefined){template['edit-link']=this.strings.parseTemplate(this.ui['edit-link'],{sc:prefix,href:comment.url||this.instance['file-path'],permalink:commentKey})}if(this.setup['allows-likes']!==false){this.addRatings(comment,template,'like',commentKey)}if(this.setup['allows-dislikes']!==false){this.addRatings(comment,template,'dislike',commentKey)}template.name=this.strings.parseTemplate(this.ui['name-wrapper'],{class:nameClass,link:nameElement});if(comment.ipaddr!==undefined){template['ipaddr']=this.strings.parseTemplate(this.ui['ip-span'],{ipaddr:comment.ipaddr})}if(comment['status-text']!==undefined){commentDate+=' ('+comment['status-text']+')'}template.date=this.strings.parseTemplate(this.ui['date-link'],{sc:prefix,href:comment.url||this.instance['file-path'],permalink:'sc-'+commentKey,title:comment['date-time'],date:commentDate});template.page=this.strings.parseTemplate(this.ui['page-comment'],{sc:prefix,permalink:'sc-'+commentKey,text:document.querySelector("#comments")&&document.querySelector("#comments").dataset.ren!==undefined&&document.querySelector("#comments").dataset.ren==='*'?(commentKey.includes('r')||!commentKey.includes('_'))?'':'<i class="fas fa-caret-left mr-1"></i>Episode '+commentKey.replace('c','').split('_')[0]:''});template['reply-link']=this.strings.parseTemplate(this.ui['reply-link'],{sc:prefix,href:comment.url||this.instance['file-path'],permalink:commentKey,class:replyClass,title:replyTitle});if(comment.replies!==undefined){template['reply-count']=comment.replies.length;if(template['reply-count']>0){if(template['reply-count']!==1){template['reply-count']+=' '+this.locale['replies']}else{template['reply-count']+=' '+this.locale['reply']}}}var reply_tag=comment['reply-to']||'';if(reply_tag!==''){reply_tag='<a rel="nofollow" href="javascript:;" class="tag-name">@'+reply_tag+'</a> '}var body=comment.body.replace(this.rx.links,this.rx.html.linksReplace);if(sc.setup['allows-images']!==false){body=body.replace(this.rx.imageTags,function(m,link,url){return sc.embedImage.apply(sc,arguments)})}if(this.setup['uses-markdown']!==false){body=this.parseMarkdown(body)}if(this.rx.html.code.open.test(body)===true){var codeReplacer=function(fullTag,open,html,close){var codeMarker=open+'CODE_TAG['+codeTagCount+']'+close;codeTags[codeTagCount]=sc.EOLTrim(html);codeTagCount++;return codeMarker};body=body.replace(this.rx.html.code.replace,codeReplacer)}if(this.rx.html.pre.open.test(body)===true){var preReplacer=function(fullTag,open,html,close){var preMarker=open+'PRE_TAG['+preTagCount+']'+close;preTags[preTagCount]=sc.EOLTrim(html);preTagCount++;return preMarker};body=body.replace(this.rx.html.pre.replace,preReplacer)}if(this.rx.html.trimTags.open.test(body)===true){var tagTrimmer=function(fullTag,open,name,html,close){return open+sc.EOLTrim(html)+close};body=body.replace(this.rx.html.trimTags.replace,tagTrimmer)}var paragraphs=body.split(this.rx.paragraphs);var pdComment='';for(var i=0,il=paragraphs.length;i<il;i++){var lines=paragraphs[i].replace(this.rx.html.lines,'<br>');pdComment+='<p>'+reply_tag+lines+'</p>'+this.setup['server-eol']}if(codeTagCount>0){pdComment=pdComment.replace(this.rx.html.code.marker,function(m,i){return codeTags[i]})}if(preTagCount>0){pdComment=pdComment.replace(this.rx.html.pre.marker,function(m,i){return preTags[i]})}template.comment=pdComment}else{classes+=' sc-notice '+comment['notice-class'];template.comment=comment.notice;template.name=this.strings.parseTemplate(this.ui['name-wrapper'],{class:nameClass,link:comment.title})}var html=this.strings.parseTemplate(this.ui['theme'],template);if(comment.replies!==undefined){classes+=' sc-has-replies';if(comment.replies.length>1){replies+='<div class="sc-rep-more sc-rep-in"><a rel="nofollow" href="javascript:;" class="sc-btn-show-rep" id="sc-view-replies-'+comment.permalink+'" data-id="'+comment.permalink+'"><i class="fas fa-caret-down mr-2"></i><span>'+comment.replies.length+' replies</span></a></div><div class="sc-replies-wrap" id="sc-replies-'+comment.permalink+'" style="display: none;">'}else{replies+='<div class="sc-rep-more sc-rep-in"><a rel="nofollow" href="javascript:;" class="sc-btn-show-rep" id="sc-view-replies-'+comment.permalink+'" data-id="'+comment.permalink+'"><i class="fas fa-caret-down mr-2"></i><span>'+comment.replies.length+' reply</span></a></div><div class="sc-replies-wrap" id="sc-replies-'+comment.permalink+'" style="display: none;">'}for(var i=0,il=comment.replies.length;i<il;i++){replies+=this.parseComment(comment.replies[i],comment,collapse)}replies+='</div>'}var wrapper=this.strings.parseTemplate(this.ui['comment-wrapper'],{sc:prefix,permalink:commentKey,class:classes,html:html+replies});return wrapper};SCommentConstructor.prototype.getElement=function(id,asIs){id=(asIs===true)?id:this.prefix(id);var element=document.getElementById(id);return element};SCommentConstructor.prototype.elementExists=function(id,callback,asIs){var element=this.getElement(id,asIs);if(element!==null){return callback(element)}return false};SCommentConstructor.prototype.eachClass=function(element,className,callback){var elements=element.getElementsByClassName(className);for(var i=elements.length-1;i>=0;i--){callback(elements[i],elements,i,className)}};SComment.prototype.parseAll=function(comments,element,collapse,popular){var html='';for(var i=0,il=comments.length;i<il;i++){html+=this.parseComment(comments[i],null,collapse,popular)}var htmlStart=Date.now();if('insertAdjacentHTML' in element){element.textContent='';element.insertAdjacentHTML('beforeend',html)}else{element.innerHTML=html}var htmlTime=Date.now()-htmlStart;for(var i=0,il=comments.length;i<il;i++){this.addControls(comments[i])}return htmlTime};SComment.prototype.cloneObject=function(object){return JSON.parse(JSON.stringify(object))};SComment.prototype.getAllComments=function(comments){var output=[];var tmpArray=this.cloneObject(comments);function descend(comment){output.push(comment)}for(var i=0,il=tmpArray.length;i<il;i++){descend(tmpArray[i])}return output};SComment.prototype.sortComments=function(comments,method){method=method||this.setup['default-sorting'];var defaultName=this.setup['default-name'];function sortByDate(a,b){if(b.timestamp!==a.timestamp){return b.timestamp-a.timestamp}return 1}function netLikes(comment){var likes=comment.likes||0;var dislikes=comment.dislikes||0;return likes-dislikes}function replyCounter(comment){return comment.replies?comment.replies.length:0}function replySum(comment,callback){var sum=0;if(comment.replies!==undefined){for(var i=0,il=comment.replies.length;i<il;i++){sum+=replySum(comment.replies[i],callback)}}sum+=callback(comment);return sum}function sortByCommenter(a,b){var nameA=(a.name||defaultName).toLowerCase();var nameB=(b.name||defaultName).toLowerCase();nameA=(nameA.charAt(0)==='@')?nameA.slice(1):nameA;nameB=(nameB.charAt(0)==='@')?nameB.slice(1):nameB;if(nameA!==nameB){return(nameA>nameB)?1:-1}return 0}switch(method){case 'descending':{var sortArray=this.getAllComments(comments);return sortArray.reverse()}case 'by-date':{var sortArray=this.getAllComments(comments);return sortArray.sort(sortByDate)}case 'by-likes':{var sortArray=this.getAllComments(comments);return sortArray.sort(function(a,b){return netLikes(b)-netLikes(a)})}case 'by-replies':{var sortArray=this.cloneObject(comments);return sortArray.sort(function(a,b){return replyCounter(b)-replyCounter(a)})}case 'by-discussion':{var sortArray=this.cloneObject(comments);return sortArray.sort(function(a,b){var replyCountA=replySum(a,replyCounter);var replyCountB=replySum(b,replyCounter);return replyCountB-replyCountA})}case 'by-popularity':{var sortArray=this.cloneObject(comments);return sortArray.sort(function(a,b){var likeCountA=replySum(a,netLikes);var likeCountB=replySum(b,netLikes);return likeCountB-likeCountA})}case 'by-name':{var sortArray=this.getAllComments(comments);return sortArray.sort(sortByCommenter)}case 'threaded-descending':{var sortArray=this.cloneObject(comments);return sortArray.reverse()}case 'threaded-by-date':{var sortArray=this.cloneObject(comments);return sortArray.sort(sortByDate)}case 'threaded-by-likes':{var sortArray=this.cloneObject(comments);return sortArray.sort(function(a,b){return netLikes(b)-netLikes(a)})}case 'threaded-by-name':{var sortArray=this.cloneObject(comments);return sortArray.sort(sortByCommenter)}}return comments};SComment.prototype.sortPrimary=function(method,collapse){var dest=this.instance['sort-section'];var sortStart=Date.now();var sorted=this.sortComments(this.instance.comments.primary,method);if(collapse===true){this.instance.collapseLimit=0}var sortTime=Date.now()-sortStart;var htmlTime=this.parseAll(sorted,dest,collapse);console.log(this.strings.sprintf('SComment: sorting %d ms, HTML %d ms',[ sortTime,htmlTime ]))};SComment.prototype.htmlChildren=function(html){var div=this.createElement('div',{innerHTML:html});return div.children};SComment.prototype.appendComments=function(comments,dest,parent){var sc=this;dest=dest||this.instance['sort-section'];var htmlTime=0;for(var i=0,il=comments.length;i<il;i++){var comment=comments[i];var element=this.getElement(comment.permalink);if(element!==null){element.parentNode.appendChild(element);var repliesElement=this.getElement('replies-'+comment.permalink);if(comment.replies!==undefined){if(repliesElement===null){var repliesHtml='<div class="sc-rep-more sc-rep-in"><a rel="nofollow" href="javascript:;" class="sc-btn-show-rep active" id="sc-view-replies-'+comment.permalink+'" data-id="'+comment.permalink+'"><i class="fas fa-caret-down mr-2"></i><span>1 reply</span></a></div><div class="sc-replies-wrap" id="sc-replies-'+comment.permalink+'" style="display: none;">';if('insertAdjacentHTML' in dest){element.insertAdjacentHTML('beforeend',repliesHtml)}else{var element1=this.htmlChildren(repliesHtml);element.appendChild(element1[0])}repliesElement=this.getElement('replies-'+comment.permalink)}else{var viewMoreReplies=element.querySelector('.sc-btn-show-rep');if(comment.replies.length>1){viewMoreReplies.innerHTML='<i class="fas fa-caret-down mr-2"></i><span>'+comment.replies.length+' replies</span>'}else{viewMoreReplies.innerHTML='<i class="fas fa-caret-down mr-2"></i><span>'+comment.replies.length+' reply</span>'}}this.appendComments(comment.replies,repliesElement,comment)}continue}var html=this.parseComment(comment,parent);var htmlStart=Date.now();if(parent!==undefined){dest.style.display='';var viewMoreReplies=dest.parentNode.querySelector('.sc-btn-show-rep');viewMoreReplies.onclick=function(){sc.toggleReplies(viewMoreReplies.dataset.id);return false};this.classes.add(viewMoreReplies,'active')}if('insertAdjacentHTML' in dest){dest.insertAdjacentHTML('beforeend',html)}else{var element=this.htmlChildren(html);dest.appendChild(element[0])}var htmlEnd=Date.now();htmlTime+=htmlEnd-htmlStart;this.addControls(comment)}this.reappendMoreLink();return htmlTime};SComment.prototype.messageTimeouts={};SComment.prototype.computeStyle=function(element,property,type){if(window.getComputedStyle!==undefined){var computedStyle=window.getComputedStyle(element,null);computedStyle=computedStyle.getPropertyValue(property)}else{var computedStyle=element.currentStyle[property]}switch(type){case 'int':{computedStyle=computedStyle.replace(/px|em/,'');computedStyle=parseInt(computedStyle)||0;break}case 'float':{computedStyle=computedStyle.replace(/px|em/,'');computedStyle=parseFloat(computedStyle)||0.0;break}}return computedStyle};SComment.prototype.getHeight=function(element,setChild){var firstChild=element.children[0];firstChild.style.maxHeight='initial';var borderTop=this.computeStyle(firstChild,'border-top-width','int');var borderBottom=this.computeStyle(firstChild,'border-bottom-width','int');var marginBottom=this.computeStyle(firstChild,'margin-bottom','int');var border=borderTop+borderBottom;var maxHeight=firstChild.clientHeight+border+marginBottom;if(setChild===true){firstChild.style.maxHeight=maxHeight+'px'}else{firstChild.style.maxHeight=''}return maxHeight};SComment.prototype.openMessage=function(element){var sc=this;this.classes.remove(element,'sc-message-animated');this.classes.add(element,'sc-message-open');var maxHeight=this.getHeight(element);var firstChild=element.children[0];this.classes.remove(element,'sc-message-open');setTimeout(function(){sc.classes.add(element,'sc-message-open');sc.classes.add(element,'sc-message-animated');element.style.maxHeight=maxHeight+'px';firstChild.style.maxHeight=maxHeight+'px';setTimeout(function(){element.style.maxHeight='initial';firstChild.style.maxHeight='initial'},150)},150)};SComment.prototype.closeMessage=function(element){var sc=this;element.style.maxHeight=this.getHeight(element,true)+'px';setTimeout(function(){element.children[0].style.maxHeight='';element.style.maxHeight='';sc.classes.remove(element,'sc-message-open');sc.classes.remove(element,'sc-message-error')},150)};SComment.prototype.showMessage=function(messageText,type,permalink,error){var sc=this;if(type==='edit'){var container=this.getElement('edit-message-container-'+permalink);var message=this.getElement('edit-message-'+permalink)}else{if(type!=='reply'){var container=this.getElement('message-container');var message=this.getElement('message')}else{var container=this.getElement('reply-message-container-'+permalink);var message=this.getElement('reply-message-'+permalink)}}if(messageText!==undefined&&messageText!==''){message.textContent=messageText;if(error===true){this.classes.add(container,'sc-message-error')}}this.openMessage(container);var key=this.prefix(permalink);if(this.messageTimeouts[key]===undefined){this.messageTimeouts[key]={}}if(this.messageTimeouts[key][type]!==undefined){clearTimeout(this.messageTimeouts[key][type])}this.messageTimeouts[key][type]=setTimeout(function(){sc.closeMessage(container)},10000)};SComment.prototype.emailValidator=function(form,subscribe,type,permalink){if(form.email===undefined){return true}if(form.email.value===''){return true;var notifications=confirm(this.locale['no-email-warning']);if(notifications===false){form.email.focus();return false}}else{if(this.rx.email.test(form.email.value)===false){var message=this.locale['invalid-email'];this.showMessage(message,type,permalink,true);form.email.focus();return false}}return true};SComment.prototype.validateEmail=function(type,permalink,form){var subscribe=type+'-subscribe';if(type==='reply'||type==='edit'){subscribe+='-'+permalink}var valid=this.emailValidator(form,subscribe,type,permalink);return valid};SComment.prototype.commentValidator=function(form,type,skipComment){for(var field in this.setup['form-fields']){if(this.setup['form-fields'].hasOwnProperty(field)!==true){continue}if(this.setup['form-fields'][field]==='required'&&form[field]!==undefined&&form[field].value!==undefined){if(form[field].value===''){this.classes.add(form[field],'sc-emphasized-input');form[field].focus();return this.strings.sprintf(this.locale['field-needed'],[this.locale[field]])}this.classes.remove(form[field],'sc-emphasized-input')}}if(skipComment!==true&&form.comment.value===''){this.classes.add(form.comment,'sc-emphasized-input');form.comment.focus();var localeKey=(type==='reply')?'reply-needed':'comment-needed';var errorMessage=this.locale[localeKey];return errorMessage}return true};SComment.prototype.validateComment=function(form,type,permalink,skipComment){var message=this.commentValidator(form,type,skipComment);if(message!==true){this.showMessage(message,type,permalink,true);return false}if(this.setup['user-is-logged-in']===false||type==='edit'){if(this.validateEmail(type,permalink,form)===false){return false}}return true};SComment.prototype.addComments=function(comment,type){if(type==='reply'){var parent=this.permalinkComment(this.permalinkParent(comment.permalink),this.instance.comments.primary);if(parent!==null){if(parent.replies!==undefined){parent.replies.push(comment)}else{parent.replies=[ comment ]}return}}this.instance.comments.primary.push(comment)};SComment.prototype.incrementCounts=function(type){if(type!=='reply'){this.instance['primary-count']++}this.instance['total-count']++};SComment.prototype.AJAXPost=function(json,permalink,type){var sc=this;if(type==='reply'){var dest=this.getElement(permalink)}else{var dest=this.instance['sort-section']}var comments=this.instance.comments.primary;if(this.instance['total-count']===0){this.instance.comments.primary[0]=json.comment;dest.innerHTML=this.parseComment(json.comment)}else{this.addComments(json.comment,type);this.elementExists('sort-select',function(sortSelect){comments=sc.sortComments(comments,sortSelect.value)});this.appendComments(comments)}this.addControls(json.comment);this.getElement('count').innerHTML='<i class="far fa-comment-alt mr-2"></i>'+json.count;this.getElement('count-wrapper').style.display='';this.incrementCounts(type)};SComment.prototype.AJAXEdit=function(json,permalink){var comment=this.getElement(permalink);var oldItem=this.permalinkComment(permalink,this.instance.comments.primary);var newComment=this.htmlChildren(this.parseComment(json.comment));var newElements=newComment[0].children;var oldElements=comment.children;for(var i=newElements.length-1;i>=0;i--){comment.replaceChild(newElements[i],oldElements[i])}this.addControls(json.comment);for(var attribute in json.comment){if(json.comment.hasOwnProperty(attribute)===true){oldItem[attribute]=json.comment[attribute]}}};SComment.prototype.postRequest=function(form,button,type,permalink,callback){var sc=this;var inputs=form.elements;var queries=[];function commentHandler(json){if(json.comment!==undefined){if(type!=='edit'){sc.AJAXPost.apply(sc,[ json,permalink,type ])}else{sc.AJAXEdit.apply(sc,[ json,permalink ])}if(typeof(callback)==='function'){callback()}setTimeout(function(){var scrollToElement=sc.getElement(json.comment.permalink);scrollToElement.scrollIntoView({behavior:'smooth',block:'start',inline:'start'})},105);form.comment.value='';setTimeout(function(){button.disabled=false},1000)}else{sc.showMessage(json.message,type,permalink,true);return false}}function sendRequest(){var postQueries=queries.concat([button.name+'='+encodeURIComponent(button.value)]);sc.ajax('POST',form.action,postQueries,commentHandler,true)}for(var i=0,il=inputs.length;i<il;i++){if(inputs[i].type==='submit'){continue}if(inputs[i].type==='checkbox'&&inputs[i].checked!==true){continue}var value=encodeURIComponent(inputs[i].value);queries.push(inputs[i].name+'='+value)}queries=queries.concat(['time='+SComment.getClientTime(),'ajax=yes']);if(this.setup['user-is-admin']!==true&&this.setup['uses-auto-login']!==false){if(this.setup['user-is-logged-in']!==true){var loginQueries=queries.concat([ 'login=Login' ]);this.ajax('POST',form.action,loginQueries,sendRequest,true)}else{sendRequest()}}else{sendRequest()}setTimeout(function(){button.disabled=false},10000);return false};SComment.prototype.postComment=function(form,button,type,permalink,callback){if(this.validateComment(form,type,permalink)===false){return false}setTimeout(function(){button.disabled=true},250);if(this.setup['uses-ajax']!==false){return this.postRequest.apply(this,arguments)}setTimeout(function(){button.disabled=false},10000);return true};SCommentConstructor.prototype.permalinkFile=function(permalink){var file=permalink.slice(1);file=file.replace(/r/g,'-');file=file.replace('-pop','');return file};SComment.prototype.cancelSwitcher=function(form,link,wrapper,permalink){var reset={textContent:link.textContent,title:link.title,onclick:link.onclick};function linkOnClick(){$(wrapper).slideToggle(100);setTimeout(function(){wrapper.textContent=''},100);link.onclick=reset.onclick;link.blur();return false}link.onclick=linkOnClick;if(this.setup['uses-cancel-buttons']!==false){var cancelButtonId=form+'-cancel-'+permalink;var cancelButton=this.getElement(cancelButtonId);cancelButton.onclick=linkOnClick}};SComment.prototype.formattingOnclick=function(type,permalink){return;permalink=permalink?'-'+permalink:'';var sc=this;var link=this.getElement(type+'-formatting'+permalink);var message=this.getElement(type+'-formatting-message'+permalink);link.onclick=function(){if(sc.classes.contains(message,'sc-message-open')){sc.closeMessage(message);return false}sc.openMessage(message);return false}};SCommentConstructor.prototype.duplicateProperties=function(element,names,value){var properties={};for(var i=0,il=names.length;i<il;i++){properties[(names[i])]=value}element=this.addProperties(element,properties);return element};SComment.prototype.enterCheck=function(event){return(event.keyCode===13)?false:true};SComment.prototype.preventSubmit=function(form){var infoInputs=form.getElementsByClassName('sc-input-info');for(var i=0,il=infoInputs.length;i<il;i++){infoInputs[i].onkeypress=this.enterCheck}};SComment.prototype.replyToComment=function(comment){var permalink=comment.permalink;var sc=this;var link=this.getElement('reply-link-'+permalink);var file=this.permalinkFile(permalink);var form=this.createElement('form',{id:this.prefix('reply-'+permalink),className:'sc-reply-form',action:this.setup['http-backend']+'/form-actions.php',method:'post'});form.innerHTML=this.strings.parseTemplate(this.ui['reply-form'],{sc:this.prefix(),permalink:permalink,url:this.instance['page-url'],thread:this.instance['thread-name'],title:this.instance['page-title'],file:file,rparam:document.querySelector("#comments").dataset.ren,wparam:document.querySelector("#comments").dataset.wen,replyTo:comment['user-owned']?'':comment.name||''});this.preventSubmit(form);var replyForm=this.getElement('placeholder-reply-form-'+permalink);replyForm.appendChild(form);setTimeout(function(){$(replyForm).slideToggle(100)},3);this.cancelSwitcher('reply',link,replyForm,permalink);var postReply=this.getElement('reply-post-'+permalink);this.formattingOnclick('reply',permalink);this.duplicateProperties(postReply,[ 'onclick','onsubmit' ],function(){return sc.postComment(form,this,'reply',permalink,link.onclick)});setTimeout(function(){form.comment.focus()},105);return true};SComment.prototype.toggleReplies=function(permalink){var sc=this;var element=this.getElement('replies-'+permalink);var viewMoreReplies=element.parentNode.querySelector('.sc-btn-show-rep');if(this.classes.contains(viewMoreReplies,'active')){$('#sc-replies-'+permalink).slideToggle(200);this.classes.remove(viewMoreReplies,'active')}else{$('#sc-replies-'+permalink).slideToggle(200);this.classes.add(viewMoreReplies,'active')}return true};SComment.prototype.editComment=function(comment,callback){if(comment['editable']!==true){return false}var sc=this;var editInfo=SComment.backendPath+'/comment-info.php';var permalink=comment.permalink;var file=this.permalinkFile(permalink);var queries=['url='+encodeURIComponent(this.instance['page-url']),'thread='+encodeURIComponent(this.instance['thread-name']),'comment='+encodeURIComponent(file)];var link=this.getElement('edit-link-'+permalink);this.classes.add(link,'sc-loading');this.ajax('post',editInfo,queries,function(info){if(info.error!==undefined){alert(info.error);sc.classes.remove(link,'sc-loading');return}var body=info.body.replace(sc.rx.links,'$1');var placeholder=sc.getElement('placeholder-edit-form-'+permalink);var statuses=[ 'approved','pending','deleted' ];var form=sc.createElement('form',{id:sc.prefix('edit-'+permalink),className:'sc-edit-form',action:sc.setup['http-backend']+'/form-actions.php',method:'post'});form.innerHTML=sc.strings.parseTemplate(sc.ui['edit-form'],{sc:sc.prefix(),permalink:permalink,url:sc.instance['page-url'],thread:sc.instance['thread-name'],title:sc.instance['page-title'],file:file,name:info.name||'',email:info.email||'',website:info.website||'',body:body});sc.preventSubmit(form);placeholder.appendChild(form);sc.elementExists('edit-status-'+permalink,function(status){if(comment.status!==undefined){status.selectedIndex=statuses.indexOf(comment.status)}});sc.elementExists('edit-subscribe-'+permalink,function(sub){if(comment.subscribed!==true){sub.checked=null}});var editDelete=sc.getElement('edit-delete-'+permalink);var saveEdit=sc.getElement('edit-post-'+permalink);sc.cancelSwitcher('edit',link,placeholder,permalink);editDelete.onclick=function(){return confirm(sc.locale['delete-comment'])};sc.formattingOnclick('edit',permalink);sc.duplicateProperties(saveEdit,[ 'onclick','onsubmit' ],function(){return sc.postComment(form,this,'edit',permalink,link.onclick)});sc.classes.remove(link,'sc-loading');if(typeof(callback)==='function'){callback()}},true);return false};SComment.prototype.mouseOverChanger=function(element,over,out){var sc=this;if(over===null||out===null){element.onmouseover=null;element.onmouseout=null;return false}element.onmouseover=function(){this.textContent=sc.locale[over]};element.onmouseout=function(){this.textContent=sc.locale[out]}};SComment.prototype.likeComment=function(action,permalink){var sc=this;var file=this.permalinkFile(permalink);var actionLink=this.getElement(action+'-'+permalink);var action1=(action==='like')?'dislike':'like';var actionLink1=this.getElement(action1+'-'+permalink);sc.classes.add(actionLink1,'sc-'+action1);sc.classes.remove(actionLink1,'sc-'+action1+'d');var likesElement=this.getElement('likes-'+permalink);var dislikesElement=this.getElement('dislikes-'+permalink);var likePath=this.setup['http-backend']+'/like.php';var queries=['url='+encodeURIComponent(this.instance['page-url']),'thread='+encodeURIComponent(this.instance['thread-name']),'comment='+encodeURIComponent(file),'action='+action];this.ajax('POST',likePath,queries,function(likeResponse){if(likeResponse.message!==undefined){alert(likeResponse.message);return}if(likeResponse.error!==undefined){alert(likeResponse.error);return}var likesKey='likes';var dislikesKey='dislikes';var likes=likeResponse[likesKey]||0;var dislikes=likeResponse[dislikesKey]||0;if(sc.classes.contains(actionLink,'sc-'+action)===true){var title=(action==='like')?'liked-comment':'disliked-comment';var content=(action==='like')?'liked':'disliked';sc.classes.add(actionLink,'sc-'+action+'d');sc.classes.remove(actionLink,'sc-'+action);actionLink.title=sc.locale[title];if(action==='like'){sc.mouseOverChanger(actionLink,null,null)}}else{var title=(action==='like')?'like-comment':'dislike-comment';var content=(action==='like')?'like':'dislike';sc.classes.add(actionLink,'sc-'+action);sc.classes.remove(actionLink,'sc-'+action+'d');actionLink.title=sc.locale[title];if(action==='like'){sc.mouseOverChanger(actionLink,null,null)}}if(likes>0){if(likes!==1){var likeLocale='likes'}else{var likeLocale='like'}likesElement.textContent=likes;}else{likesElement.textContent='';likesElement.style.fontWeight=''}if(dislikes>0){if(dislikes!==1){var likeLocale='dislikes'}else{var likeLocale='dislike'}dislikesElement.textContent=dislikes;}else{dislikesElement.textContent='';dislikesElement.style.fontWeight=''}},true)};SCommentConstructor.prototype.addControls=function(comment){var sc=this;function stepIntoReplies(){if(comment.replies!==undefined){for(var i=0,il=comment.replies.length;i<il;i++){sc.addControls(comment.replies[i])}}}if(comment.notice!==undefined){stepIntoReplies();return false}var permalink=comment.permalink;if(this.setup['allows-images']!==false){var main=this.instance['main-element'];var embeds=main.getElementsByClassName('sc-embedded-image');for(var i=0,il=embeds.length;i<il;i++){embeds[i].onclick=function(){sc.openEmbeddedImage(this)}}}this.elementExists('thread-link-'+permalink,function(threadLink){threadLink.onclick=function(){var callback=function(){var parentThread=permalink.replace(sc.rx.thread,'$1');var scrollToElement=sc.getElement(parentThread);scrollToElement.scrollIntoView({behavior:'smooth',block:'start',inline:'start'})};if(sc.setup['collapses-comments']!==false){sc.showMoreComments(threadLink,callback)}else{callback()}return false}});this.elementExists('view-replies-'+permalink,function(replies){replies.onclick=function(){sc.toggleReplies(permalink);replies.blur();return false}});this.elementExists('reply-link-'+permalink,function(replyLink){replyLink.onclick=function(){sc.replyToComment(comment);replyLink.blur();return false}});this.elementExists('edit-link-'+permalink,function(editLink){editLink.onclick=function(){sc.editComment(comment);return false}});if(this.setup['allows-likes']!==false){this.elementExists('like-'+permalink,function(likeLink){likeLink.onclick=function(){if(comment['user-owned']===undefined){sc.likeComment('like',permalink)}likeLink.blur();return false}})}if(this.setup['allows-dislikes']!==false){this.elementExists('dislike-'+permalink,function(dislikeLink){dislikeLink.onclick=function(){if(comment['user-owned']===undefined){sc.likeComment('dislike',permalink)}dislikeLink.blur();return false}})}stepIntoReplies()};SCommentConstructor.prototype.appendCSS=function(id){var head=document.head||document.getElementsByTagName('head')[0];var links=head.getElementsByTagName('link');var themeRegex=new RegExp(this.setup['theme-css']);var mainElement=this.getMainElement(id);for(var i=0,il=links.length;i<il;i++){if(themeRegex.test(links[i].href)===true){if(links[i].loaded===false){mainElement.style.display='none'}return}}var css=this.createElement('link',{rel:'stylesheet',href:this.setup['theme-css'],type:'text/css',loaded:false});if(css.onload!==undefined){var onLoadError=function(){var scs=document.getElementsByClassName('sc');for(var i=0,il=scs.length;i<il;i++){scs[i].style.display=''}css.loaded=true};mainElement.style.display='none';css.addEventListener('load',onLoadError,false);css.addEventListener('error',onLoadError,false)}head.appendChild(css)};SComment.prototype.appendRSS=function(){var head=document.head||document.getElementsByTagName('head')[0];var pageURL=encodeURIComponent(this.instance['page-url']);var rss=this.createElement('link',{rel:'alternate',href:this.setup['rss-api']+'?url='+pageURL,type:'application/rss+xml',title:'Comments'});head.appendChild(rss)};SComment.prototype.showInterface=function(callback){var sc=this;var hiddenIds=[ 'form-section','comments-section','end-links' ];this.elementExists('show-interface-link',function(showLink){sc.classes.add(showLink,'sc-hide-more-link');setTimeout(function(){showLink.parentNode.removeChild(showLink);for(var i=0,il=hiddenIds.length;i<il;i++){sc.elementExists(hiddenIds[i],function(element){element.style.display=''})}if(sc.setup['collapse-limit']>0){sc.elementExists('popular-section',function(popularSection){popularSection.style.display=''})}if(typeof(callback)==='function'){callback()}},350)})};SComment.prototype.showInterfaceLink=function(){var sc=this;var main=this.instance['main-element'];if(this.instance['total-count']>=1){var text=this.instance['show-comments']}else{var text=this.instance['post-a-comment']}main.appendChild(this.createElement('a',{id:this.prefix('show-interface-link'),className:'sc-more-link',rel:'nofollow',href:'#',title:text,text:text,onclick:function(){sc.showInterface();return false}}))};SComment.prototype.loadAllComments=function(element,loadMore,callback){var sc=this;var maxComments=this.instance['max-comments']||this.setup['collapse-limit'];if(loadMore){maxComments+=this.setup['collapse-limit']}if(this.instance['comments-loaded']===true){return callback()}var sortBy=this.setup['default-sorting'];var sortSelect=sc.getElement('sort-select');if(sortSelect!==null){sortBy=sortSelect.value}var requestPath=this.setup['http-backend']+'/load-comments.php';const read_ep=document.querySelector("#comments").dataset.ren;const write_ep=document.querySelector("#comments").dataset.wen;var queries=this.queries.concat(['time='+SComment.getClientTime(),'read='+read_ep,'write='+write_ep,'ajax=yes','max='+maxComments,'sort='+sortBy]);this.classes.add(element,'sc-loading');this.ajax('POST',requestPath,queries,function(json){sc.instance['max-comments']=maxComments;sc.classes.remove(element,'sc-loading');sc.instance.comments.primary=json.primary;if(sc.instance['primary-count']>json.primary.length){sc.instance['comments-loaded']=false}else{sc.instance['comments-loaded']=true;sc.instance['showing-more']=true}console.log(sc.strings.sprintf('SComment: backend %d ms, %s',[json.statistics['execution-time'],json.statistics['script-memory']]));callback()},true);this.instance['comments-loaded']=true};SComment.prototype.showMoreComments=function(element,callback){var sc=this;if(this.instance['showing-more']===true){if(typeof(callback)==='function'){callback()}return false}if(this.setup['uses-ajax']===false){this.hideMoreLink(callback);this.instance['showing-more']=true;return false}this.loadAllComments(element,true,function(){sc.hideMoreLink(function(){var execStart=Date.now();var primary=sc.instance.comments.primary;var sortSelect=sc.getElement('sort-select');if(sortSelect!==null){var sorted=sc.sortComments(primary,sortSelect.value)}else{var sorted=sc.sortComments(primary)}var htmlTime=sc.appendComments(sorted);if(typeof(callback)==='function'){callback()}var execTime=Math.abs(Date.now()-execStart-htmlTime);console.log(sc.strings.sprintf('SComment: front-end %d ms, HTML %d ms',[ execTime,htmlTime ]))})});this.instance['showing-more']=false;return false};SComment.prototype.hideMoreLink=function(callback){var sc=this;var sortSection=this.instance['sort-section'];var moreLink=this.instance['more-link'];this.classes.add(this.instance['more-link'],'sc-hide-more-link');setTimeout(function(){moreLink.parentNode.removeChild(moreLink);sc.getElement('count-wrapper').style.display='';sc.elementExists('popular-section',function(popularSection){popularSection.style.display=''});var classRemover=function(element,elements,i,className){sc.classes.remove(element,className)};sc.eachClass(sortSection,'sc-hidden',classRemover);if(typeof(callback)==='function'){callback()}},350)};SComment.prototype.showMoreLink=function(){var sc=this;if(this.instance['primary-count']>this.setup['collapse-limit']){this.instance['more-link']=this.createElement('a',{className:'sc-more-link',rel:'nofollow',href:'javascript:;',title:'View more',innerHTML:'<i class="fas fa-caret-down mr-2"></i>View more',onclick:function(){return sc.showMoreComments(this)}});var sortSection=this.instance['sort-section'];var comments=sortSection.children;this.instance['last-shown-comment']=comments[comments.length-1];sortSection.appendChild(this.instance['more-link']);this.instance['showing-more']=false}else{this.instance['showing-more']=false}};SComment.prototype.reappendMoreLink=function(){var moreLink=this.instance['more-link'];var showingMore=this.instance['showing-more'];if(moreLink!==undefined&&showingMore===false){var sortSection=this.instance['sort-section'];var lastShown=this.instance['last-shown-comment'];sortSection.insertBefore(moreLink,sortSection.nextSibling)}};SComment.prototype.init=function(id){var sc=this;var execStart=Date.now();var mainElement=this.getMainElement(id);var formEvents=[ 'onclick','onsubmit' ];var pageURL=window.location.href.split('#')[0];pageURL=pageURL.split('?ep=')[0];pageURL=pageURL.split('/ep-')[0];var pageHash=window.location.hash.substring(1);function scrollToElement(id){sc.elementExists(id,function(element){element.scrollIntoView({behavior:'smooth',block:'start',inline:'start'})},true)}function scrollCommentIntoView(){if(sc.setup['collapses-comments']!==false){var linkedHidden=sc.elementExists(pageHash,function(comment){if(sc.classes.contains(comment,'sc-hidden')===false){scrollToElement(pageHash);return true}return false},true);if(linkedHidden===false){sc.showMoreComments(sc.instance['more-link'],function(){scrollToElement(pageHash)})}}else{scrollToElement(pageHash)}}function prepareScroll(){if(pageHash.match(/comments|sc/)){scrollToElement(pageHash)}if(pageHash.match(/sc-c[0-9]+r*/)){if(sc.setup['collapses-interface']!==false){sc.showInterface(scrollCommentIntoView)}else{scrollCommentIntoView()}}if(sc.getElement('message').textContent!==''){sc.showMessage()}}function onLoad(){setTimeout(prepareScroll,500)}if(this.setup['appends-css']!==false){this.appendCSS(id)}if(this.instance['total-count']!==0){this.elementExists('comment-count',function(countElement){countElement.textContent=sc.instance['total-count']});if(this.setup['appends-rss']!==false){this.appendRSS()}}if('insertAdjacentHTML' in mainElement){mainElement.textContent='';mainElement.insertAdjacentHTML('beforeend',this.instance['initial-html'])}else{mainElement.innerHTML=this.instance['initial-html']}this.instance['main-element']=mainElement;var sortSection=this.getElement('sort-section');this.instance['sort-section']=sortSection;this.elementExists('top-comments',function(topComments){if(sc.instance.comments.popular[0]!==undefined){sc.parseAll(sc.instance.comments.popular,topComments,false,true)}});var comments=this.instance.comments.primary;if(this.setup['collapses-comments']===false||this.setup['uses-ajax']===false){comments=this.sortComments(comments)}this.htmlTime=this.parseAll(comments,sortSection,this.setup['collapses-comments']);if(this.setup['collapses-interface']===true){this.showInterfaceLink()}if(this.setup['collapses-comments']!==false){this.showMoreLink()}this.formattingOnclick('main');var postButton=this.getElement('post-button');var formElement=this.getElement('form');this.duplicateProperties(postButton,formEvents,function(){return sc.postComment(formElement,postButton,'main')});if(this.setup['allows-login']!==false){if(this.setup['user-is-logged-in']!==true){var loginButton=this.getElement('login-button');this.duplicateProperties(loginButton,formEvents,function(){return sc.validateComment(formElement,'main',null,true)})}}this.elementExists('dropdown-sort-select',function(dropdownSortSelect){var list=dropdownSortSelect.getElementsByTagName('a');for(var item of list){item.onclick=dropdownSelect}function dropdownSelect(){var selectedItem=this;var sortSelect=sc.getElement('sort-select');sortSelect.value=selectedItem.dataset.value;sortSelect.innerHTML=selectedItem.innerHTML+'<i class="fas fa-angle-down ml-2"></i>';var list=dropdownSortSelect.getElementsByTagName('a');for(var item of list){sc.classes.remove(item,'active')}sc.classes.add(selectedItem,'active');if(sc.setup['collapses-comments']!==false){var sortSelectDiv=sc.getElement('sort');sc.loadAllComments(sortSelectDiv,false,function(){var collapse=!sc.instance['showing-more'];sc.sortPrimary(selectedItem.dataset.value,collapse);sc.reappendMoreLink()},false)}else{sc.sortPrimary(selectedItem.dataset.value)}}});if(pageURL.match(/sc-(reply|edit)=/)){var permalink=pageURL.replace(/.*?sc-(edit|reply)=(c[0-9r\-pop]+).*?/,'$2');var callback=function(){if(pageURL.match('sc-reply=')){sc.replyToComment(permalink);scrollToElement(pageHash)}else{var isPop=permalink.match('-pop');var comments=sc.instance.comments[isPop?'popular':'primary'];var edit=sc.permalinkComment(permalink,comments);sc.editComment(edit,function(){scrollToElement(pageHash)})}};if(sc.setup['collapses-comments']!==false){this.showMoreComments(this.instance['more-link'],callback)}else{callback()}}this.execTime=Math.abs(Date.now()-execStart-this.htmlTime);console.log(this.strings.sprintf('SComment: front-end %d ms, HTML %d ms',[ this.execTime,this.htmlTime ]));if(window.addEventListener){window.addEventListener('load',onLoad,false)}else{window.attachEvent('onload',onLoad)}onLoad()};
