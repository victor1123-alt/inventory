<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head.ejs') %>
</head>

<body>
    <div class="bg-light w-100" style="min-width: 576px;">
        <%- include('../partials/navbar.ejs') %>
            <div class="row mt-5 ">
                <%- include('../partials/sidebar.ejs') %>
                    <div class="col min-vh-100 pt-4">
                        <div class="bg-white mt-4 mb-4 px-4 mx-4 rounded-3 py-3">
                            <div class="text-end p-4 pb-4">
                                <span class="fw-bold">Dashboard > </span> <a href=""
                                    class="text-decoration-none">Customers</a>
                            </div>
                            <div class="d-flex justify-content-between align-items-baseline">

                                <div class="fs-4 text-primary fw-bold">
                                    Customers Details
                                </div>
                                <ul class="d-flex justify-content-around w-50 align-items-baseline"
                                    style="list-style: none;">
                                    <li class=" bg-light rounded-pill py-1 w-50 row p"><input type="text" name=""
                                            class="outline-none ps-3   border-none col-8 rounded-pill bg-light" id="">
                                        <div class="col-4 flex-column justify-content-center align-items-center d-flex">
                                            <img src="/img/Search.png" alt="">
                                        </div>
                                    </li>
                                    <li class="ps-4 pointer text-end "><img width="30px" src="/img/Filter.png" alt="">
                                    </li>
                                    <li class="px-sm-2 pointer text-end " data-bs-toggle="modal"
                                        data-bs-target="#addInvent"><img src="/img/Add.png" width="30px" alt=""></li>

                                </ul>
                            </div>
                            <div class="" style="overflow-x: auto;">
                                <table class="table-striped w-100 my-4">
                                    <thead class="">
                                        <tr class="text-primary">
                                            <th class="px-2  pb-4">customer ID</th>
                                            <th class="px-2  pb-4">Full Name</th>
                                            <th class="px-2  pb-4">email</th>
                                            <th class="px-2  pb-4">Phone</th>
                                            <th class="px-2  pb-4">physical Address</th>
                                            <th class="px-2 pb-4">edit</th>
                                            <th class="px-2 pb-4">delete</th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                        <% customers.forEach((sale,index)=>{%>
                                            <tr class="<%- index % 2 != 0 ? 'bg-default-blue':'' %>">
                                                <td class="py-3 mt-3 px-2">000<%- sale.customer_id %></td>
                                                <td class="py-3 mt-3 px-2"> <%- sale.first_name %> <%- sale.last_name %>
                                                </td>
                                                <td class="py-3 mt-3 px-2"><%- sale.email %></td>
                                                <td class="py-3 mt-3 px-2"><%- sale.phone_number %></td>
                                                <td class="py-3 mt-3 px-2"><%- sale.address %></td>
                                                <td class="py-3 mt-3 px-2 text-center">
                                                    <a href="#" data-bs-toggle="modal"
                                                        data-bs-target="#editCustomerModal"
                                                        onclick="populateEditModal('<%- sale.customer_id %>', '<%- sale.first_name %>', '<%- sale.last_name %>', '<%- sale.email %>', '<%- sale.phone_number %>', '<%- sale.address %>')">
                                                        <i class="bi bi-pencil-square"></i>
                                                    </a>
                                                </td>
                                                <td class="text-center">
                                                    <button class="btn btn-danger  btn-sm"
                                                        >
                                                        <i class="bi bi-trash3 delete-btn" data-id="<%- sale.customer_id %>"></i>
                                                    </button>
                                                </td>

                                            </tr>
                                            <%})%>

                                    </tbody>

                                </table>
                            </div>
                            <button type="button" class="btn btn-primary"
                                onclick="()=>{document.location.reload()}">refresh</button>


                        </div>
                        <div class="modal w-100 " id="addInvent">
                            <div class="modal-dialog modal-lg  modal-dialog-centered">
                                <div class="bg-white  container-fluid  p-sm-4 modal-content"
                                    style="border-radius: 20px;">
                                    <div class=" text-center fw-bold fs-3 py-3">
                                        Add Customer
                                    </div>
                                    <div class="">
                                        <form action="" name="customer_form">
                                            <div class="row align-items-baseline">
                                                <div class="mb-4 col">
                                                    <label for="name" class="form-label fw-bold"> customer's
                                                        firstname</label>
                                                    <input type="text" class="form-control" name="firstname"
                                                        aria-labelledby="firstname-err">
                                                    <div class="form-text text-danger err" id="firstname-err"
                                                        data-err="first_name"></div>
                                                </div>
                                                <div class="mb-4 col">
                                                    <label for="name" class="form-label fw-bold"> customer's
                                                        lastname</label>
                                                    <input type="text" class="form-control" name="lastname"
                                                        aria-labelledby="lastname-err">
                                                    <div class="form-text text-danger err" id="lastname-err"
                                                        data-err="last_name"></div>
                                                </div>
                                            </div>
                                            <div class="mb-4">
                                                <label for="name" class="form-label fw-bold"> customer's
                                                    email</label>
                                                <input type="email" class="form-control" name="email"
                                                    aria-labelledby="email-err">
                                                <div class="form-text text-danger err" id="email-err" data-err="email">
                                                </div>
                                            </div>
                                            <div class="row align-items-baseline">
                                                <div class="mb-4 col">
                                                    <label for="name" class="form-label fw-bold"> customer's
                                                        phone</label>
                                                    <input type="tel" class="form-control" name="phone"
                                                        aria-labelledby="phone-err">
                                                    <div class="form-text text-danger err" id="phone-err"
                                                        data-err="phone_number"></div>
                                                </div>
                                                <div class="mb-4 col">
                                                    <label for="name" class="form-label fw-bold"> customer's
                                                        physical address</label>
                                                    <input type="text" class="form-control" name="physicalAddress"
                                                        aria-labelledby="address-err">
                                                    <div class="form-text text-danger err" id="address-err"
                                                        data-err="address"></div>
                                                </div>
                                            </div>

                                            <div class="text-center px-5">
                                                <button class="btn btn-primary w-75 ">Add customer</button>
                                            </div>
                                        </form>
                                        <div class="position-fixed bottom-0 end-0 p-3 " style="z-index: 11000">
                                            <div id="liveToast" class="mytoast d-none modal-content " role="alert"
                                                aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
                                                <div class="toast-header border-5 border-success">
                                                    <img src="..." class="rounded me-2" alt="...">
                                                    <strong class="me-auto">success !!!</strong>
                                                </div>
                                                <div class="toast-body">
                                                    A user added successfully
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

            </div>
    </div>

    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCustomerModalLabel">Edit Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label for="editFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="editPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="editAddress" class="form-label">Address</label>
                            <input type="text" class="form-control" id="editAddress" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Enter your password to confirm deletion:</p>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Password">
                    <div class="text-danger mt-2" id="passwordError" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Confirm</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        function populateEditModal(id, firstName, lastName, email, phone, address) {
            document.getElementById("editCustomerId").value = id;
            document.getElementById("editFirstName").value = firstName;
            document.getElementById("editLastName").value = lastName;
            document.getElementById("editEmail").value = email;
            document.getElementById("editPhone").value = phone;
            document.getElementById("editAddress").value = address;
        }

        document.addEventListener("DOMContentLoaded", () => {
            let deleteCustomerId = null;

            // Attach event listener to delete buttons
            document.querySelectorAll(".delete-btn").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    console.log(e.target);
                    
                    deleteCustomerId = e.target.getAttribute("data-id"); // Get customer ID
                    const passwordModal = new bootstrap.Modal(document.getElementById("passwordModal"));
                    passwordModal.show();
                });
            });

            // Handle confirm delete
            document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
                const enteredPassword = document.getElementById("confirmPassword").value;

                // Validate the password (example validation)
                try {
                    const response = await fetch(`/api/customers/delete-customer/${deleteCustomerId}`,
                     {  method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ password:enteredPassword }),
                });

                    if (response.ok) {
                        alert("Customer deleted successfully!");
                        location.reload(); // Reload the page
                    } else {
                        alert("Failed to delete the customer.");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("An error occurred while trying to delete the item.");

                }

            });
        });


    </script>

    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <!-- <script src="/main.js" type="module"> </script> -->
    <script src="/customer.js" type="module"></script>
</body>

</html>